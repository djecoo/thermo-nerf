from dataclasses import dataclass, field
from pathlib import Path

import tyro

from thermo_nerf.evaluator.evaluator import Evaluator
from thermo_nerf.render.renderer import Renderer
from thermo_nerf.rendered_image_modalities import RenderedImageModality


@dataclass
class EvalCLIArgs:
    """Stores input arguments used for rendering."""

    model_uri: Path
    """Path to model."""
    dataset_path: Path
    """Path to a dataset containing a transforms.json file generated by COLMAP.
    Used to query the dataset first pose to generate a spiral trajectory"""
    output_folder: Path = Path("./outputs")
    """Name of the output folder to save metrics"""
    modalities_to_save: list[RenderedImageModality] = field(
        default_factory=lambda: [
            RenderedImageModality.RGB,
        ]
    )
    """Name of the renderer outputs to use: rgb, depth, accumulation."""
    keep_eval: bool = True
    """Keep the ref image in the evaluation rendering"""
    find_thermal_eval: bool = False
    """Find the thermal reference of the image"""


def main() -> None:
    tyro.extras.set_accent_color("bright_yellow")
    parameters = tyro.cli(EvalCLIArgs)

    pipeline, config = Renderer.extract_pipeline(
        parameters.model_uri, parameters.dataset_path
    )
    evaluator = Evaluator(pipeline=pipeline, config=config, modalities_to_save=parameters.modalities_to_save)

    evaluator.save_metrics(output_folder=parameters.output_folder)
    if RenderedImageModality.THERMAL in parameters.modalities_to_save and parameters.find_thermal_eval:
        evaluator.add_thermal_ref(modalities=parameters.modalities_to_save, dataset_path=parameters.dataset_path)
    evaluator.save_images(
        modalities=parameters.modalities_to_save,
        output_path=parameters.output_folder,
        keep_eval=parameters.keep_eval,
        find_thermal_eval=parameters.find_thermal_eval
    )


if __name__ == "__main__":
    main()
